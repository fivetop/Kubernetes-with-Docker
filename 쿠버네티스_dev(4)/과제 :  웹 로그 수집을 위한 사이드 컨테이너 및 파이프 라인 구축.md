![image](https://user-images.githubusercontent.com/62214428/146668478-2dafefa7-5be6-4cdf-9b6b-cec3c7b3b7c0.png)

- 웹/사이드카 컨테이너 선정의 이유 및 구축 과정에 대한 가이드라인을 상세하게 작성
- 웹/사이드카 컨테이너는 과제 수행에 적당한 것으로 자유 선택 가능
- 웹 로그를 저장하는 엘라스틱서치는 데이터가 계속 보존될 수 있도록 해결책을 제시하고, 엘라스틱서치가 새로운 버전으로 업데이트 되어도 데이터가 보존될 수 있도록 처리하는 실습이 반드시 포함되어야 함


### 계획
- ( nginx웹서버 & 파일비트 사이드카) 컨테이너 구성
- 엘라스틱서치와 키바나 각각 구성 
- 엘라스틱 서치는 별도의 볼륨을 잡아 데이터를 보존


### 과정
#### 0. 볼륨을 위해 1번노드에 data dir만들어놓기
- 나중에 hostpath를 여기로 잡을 것
![image](https://user-images.githubusercontent.com/62214428/146681372-dc015705-e23c-4134-9c21-1a178a80ea03.png)


#### 1. nginx웹서버와 파일비트 사이드카 컨테이너 구성하기
- 참고로 이미지 이름 제대로 확인하고 적어라 안그러면 pullbackoff
- https://ichi.pro/ko/filebeatleul-sidecarlo-guhyeonhayeo-elasticeulo-logeu-naebonaegi-281280391421977
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sidecar-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sidecar-pod
  template:
    metadata:
      name: sidecar-pod
      labels:
        app: sidecar-pod
    spec:
      containers:
        - name: nginx
          image: nginxdemos/hello
          ports:
            - containerPort: 80
          volumeMounts:
            - name: nginx-logs
              mountPath: var/log/nginx/
        - name: filebeat
          image: docker.elastic.co/beats/filebeat:7.14.1
          volumeMounts:
            - name: nginx-logs
              mountPath: var/log/nginx
      volumes:
      - name: nginx-logs
        hostPath:
          path: /data

```
![image](https://user-images.githubusercontent.com/62214428/146675778-c3d8254e-b7db-43c4-aaa1-9975b32f9850.png)

#### 2. nginx 외부접근위해 expose
```
kubectl expose deployment hello-deployment --type=NodePort --port=80 --target-port=80
```
![image](https://user-images.githubusercontent.com/62214428/146676937-3ce4516b-681c-40f7-a371-f48c79200451.png)
![image](https://user-images.githubusercontent.com/62214428/146676939-bd11dedf-69c7-4c5f-968c-57b39e59dbae.png)


#### 3. elasticsearch 컨테이너 구성
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: elasticsearch
  labels:
    app: elasticsearch
spec:
  replicas: 1
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      containers:
      - name: elasticsearch
        image: elastic/elasticsearch:6.4.0
        env:
        - name: discovery.type
          value: "single-node"
        ports:
        - containerPort: 9200
        - containerPort: 9300
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: elasticsearch
  name: elasticsearch-svc
  namespace: default
spec:
  ports:
  - name: elasticsearch-rest
    nodePort: 30920
    port: 9200
    protocol: TCP
    targetPort: 9200
  - name: elasticsearch-nodecom
    nodePort: 30930
    port: 9300
    protocol: TCP
    targetPort: 9300  
  selector:
    app: elasticsearch
  type: NodePort
```

#### 4. kibana 컨테이너 구성
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kibana
  labels:
    app: kibana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kibana
  template:
    metadata:
      labels:
        app: kibana
    spec:
      containers:
      - name: kibana
        image: elastic/kibana:6.4.0
        env:
        - name: SERVER_NAME
          value: "kibana.kubenetes.example.com"
        - name: ELASTICSEARCH_URL
          value: "http://elasticsearch-svc.default.svc.cluster.local:9200"
        ports:
        - containerPort: 5601
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: kibana
  name: kibana-svc
  namespace: default
spec:
  ports:
  - nodePort: 30561
    port: 5601
    protocol: TCP
    targetPort: 5601
  selector:
    app: kibana
  type: NodePort

```






