![image](https://user-images.githubusercontent.com/62214428/146668478-2dafefa7-5be6-4cdf-9b6b-cec3c7b3b7c0.png)

- 웹/사이드카 컨테이너 선정의 이유 및 구축 과정에 대한 가이드라인을 상세하게 작성
- 웹/사이드카 컨테이너는 과제 수행에 적당한 것으로 자유 선택 가능
- 웹 로그를 저장하는 엘라스틱서치는 데이터가 계속 보존될 수 있도록 해결책을 제시하고, 엘라스틱서치가 새로운 버전으로 업데이트 되어도 데이터가 보존될 수 있도록 처리하는 실습이 반드시 포함되어야 함


### 계획
- ( nginx웹서버 & 파일비트 사이드카) 컨테이너 구성
  - nginx웹 서버에 접속할 때 access.log를 filebeat가 긁어모아 이를 elasticsearch에 전달하고 저장
- 엘라스틱서치와 키바나(추가적으로 해보기) 각각 구성 
- 엘라스틱 서치는 statefulset으로 구성하여 안정적인 데이터 보존


### 과정
#### 1. storage class 생성
- https://github.com/skarltjr/Kubernetes-with-Docker/tree/main/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4_dev(2)
- ![image](https://user-images.githubusercontent.com/62214428/146725515-620bea6c-2d59-45c2-8aa6-362135dbfb2a.png)
#### 2. filebeat configMap작성
```
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-configmap
data:
  filebeat.yml: |
    filebeat:
      config:
        modules:
          path: /usr/share/filebeat/modules.d/*.yml
          reload:
            enabled: true
      modules:
      - module: nginx
        access:
          var.paths: ["/var/log/nginx/access.log*"]
        error:
          var.paths: ["/var/log/nginx/error.log*"]
    output:
      elasticsearch:
        hosts: ["elasticsearch:9200"]
```

#### 3. sidecar container 
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-deployment
  labels:
    app: hello-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello-pod
  template:
    metadata:
      name: hello-pod
      labels:
        app: hello-pod
    spec:
      containers:
        - name: hello-world
          image: nginxdemos/hello
          ports:
            - containerPort: 80
          volumeMounts:
            - name: nginx-logs
              mountPath: var/log/nginx/
        - name: filebeat-sidecar
          image: docker.elastic.co/beats/filebeat:7.14.1
          volumeMounts:
            - name: nginx-logs
              mountPath: var/log/nginx/
            - name: filebeat-config
              mountPath: /usr/share/filebeat/filebeat.yml
              subPath: filebeat.yml 
      volumes:
        - name: nginx-logs
        - name: filebeat-config
          configMap:
            name: filebeat-configmap
            items:
              - key: filebeat.yml
                path: filebeat.yml
```
- ` kubectl expose deployment hello-deployment --type=NodePort --port=80 --target-port=80`
- ![image](https://user-images.githubusercontent.com/62214428/146728391-4b32a486-2d53-4918-88ee-b7a2979ee3fa.png)
- `kubectl exec hello-deployment-7d788965bb-856xc -it -c filebeat-sidecar -- /bin/sh`
- `cd modules.d`
- `cp nginx.yml.disabled nginx.yml`
- ![image](https://user-images.githubusercontent.com/62214428/146728888-fad3a0be-4eae-4ce6-bd1b-40b66d02b1da.png)

#### 4. elastcisearch service
```
apiVersion: v1
kind: Service
metadata:
  labels:
    app: elasticsearch
  name: elasticsearch-svc
  namespace: default
spec:
  ports:
  - name: elasticsearch-rest
    port: 9200
    protocol: TCP
    targetPort: 9200
  - name: elasticsearch-nodecom
    port: 9300
    protocol: TCP
    targetPort: 9300
  clusterIP: None
  selector:
    app: elasticsearch
```
#### 5. elasticSearch container
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: elasticsearch
  labels:
    app: elasticsearch
spec:
  replicas: 1
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      containers:
      - name: elasticsearch
        image: elastic/elasticsearch:7.14.1
        env:
        - name: discovery.type
          value: "single-node"
        ports:
        - containerPort: 9200
        - containerPort: 9300
        volumeMounts:
        - name: www
          mountPath: /usr/share/elasticsearch/data
  volumeClaimTemplates:
  - metadata:
      name: www
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "my-sc"
      resources:
        requests:
          storage: 1Gi
```
- ![image](https://user-images.githubusercontent.com/62214428/146731048-5ade9f05-45a8-449c-bfcf-1b108e3d03df.png)
- https://github.com/skarltjr/Kubernetes-with-Docker/blob/main/%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4_dev(2)/7.%EC%8A%A4%ED%85%8C%EC%9D%B4%ED%8A%B8%ED%92%80%EC%85%8B.md









